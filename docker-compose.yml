version: '3'
services:
  zookeeper:
    image: wurstmeister/zookeeper
    ports: ["2181:2181"]

  kafka:
    image: wurstmeister/kafka
    ports: ["9092:9092"]
    environment:
      KAFKA_ADVERTISED_HOST_NAME: kafka
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_CREATE_TOPICS: "trump_news:1:1"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on: [zookeeper]

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.17.0
    environment:
      - discovery.type=single-node
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ports: ["9200:9200"]

  kibana:
    image: docker.elastic.co/kibana/kibana:7.17.0
    ports: ["5601:5601"]
    depends_on: [elasticsearch]

  news-producer:
    build: .
    command: python trump_news_producer.py
    env_file: .env   # <--- Reads your secrets
    environment: 
      - KAFKA_BROKER=kafka:9092
    depends_on: [kafka]

  consumer-ingest:
    build: .
    command: python consumer_ingest.py
    env_file: .env
    environment:
      - KAFKA_BROKER=kafka:9092
      - ELASTIC_HOST=elasticsearch:9200
    depends_on: [kafka, elasticsearch]

  #consumer-vader:
    #build: .
    #command: python sentiment_consumer.py
    #env_file: .env
    #environment:
      #- KAFKA_BROKER=kafka:9092
      #- ELASTIC_HOST=elasticsearch:9200
    #depends_on: [kafka, elasticsearch]

  consumer-lstm:
    build: .
    command: python consumer_lstm.py
    env_file: .env
    environment:
      - KAFKA_BROKER=kafka:9092
      - ELASTIC_HOST=elasticsearch:9200
    depends_on: [kafka, elasticsearch]

  consumer-bert:
    build: .
    command: python consumer_bert.py
    env_file: .env
    environment:
      - KAFKA_BROKER=kafka:9092
      - ELASTIC_HOST=elasticsearch:9200
    depends_on: [kafka, elasticsearch]

  word-cloud:
    build: .
    command: python word_cloud_processor.py
    env_file: .env
    environment:
      - ELASTIC_HOST=elasticsearch:9200
    depends_on: [elasticsearch]